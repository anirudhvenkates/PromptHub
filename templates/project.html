{% extends "base.html" %}
{% block content %}
<h1>{{ project.name }}</h1>
<form action="{{ url_for('update_project', project_id=project.id) }}" method="post" class="card">
  <label>Name<br><input name="name" value="{{ project.name }}"></label>
  <label>System prompt<br><textarea name="system_prompt" rows="3">{{ project.system_prompt }}</textarea></label>
  <button type="submit">Save</button>
</form>

<div class="chat card">
  <div id="chat-log" class="chat-log"></div>
  <div class="chat-input">
    <input id="msg" placeholder="Type a message..." />
    <button id="send">Send</button>
  </div>
</div>

<script>
  const sendBtn = document.getElementById('send');
  const msgInput = document.getElementById('msg');
  const log = document.getElementById('chat-log');

  function addBubble(text, who){
    const div = document.createElement('div');
    div.className = 'bubble ' + who;
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  async function sendMessage(){
    const text = msgInput.value.trim();
    if(!text) return;
    addBubble(text, 'user');
    msgInput.value='';
    const res = await fetch('{{ url_for("api_chat", project_id=project.id) }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: text})
    });
    const data = await res.json();
    if(data.reply){
      addBubble(data.reply, 'bot');
    } else {
      addBubble(data.error || 'Error', 'error');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ sendMessage(); }
  });
</script>
{% endblock %}
